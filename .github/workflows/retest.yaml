name: Detect and Trigger Retest
on:
  issue_comment:
    types: [created, edited]

jobs:
  retest:
    runs-on: ubuntu-latest
    steps:
      # Create get run id
      - name: Retest
        if: contains(github.event.comment.body, '/retest')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
        run: |
          RUNID=$(gh api "repos/$REPO/actions/runs?branch=$BRANCH_NAME&event=pull_request" | jq -r '.workflow_runs[] | select(.name == "CI") | .id'| head -n 1)
          echo $RUNID
          echo "latest run is $RUNID"
          gh api --method POST repos/$REPO/actions/runs/$RUNID/rerun-failed-jobs
